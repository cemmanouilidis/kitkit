install_dir=/opt/kitkit-1.0-rc1

echo
echo "################## BUILDING LLVM & CLANG ######################################"
echo 
cd llvm 
git submodule add -f http://llvm.org/git/clang.git tools/clang 
git submodule update --init
cd tools/clang 
git checkout 863fb3574468ef9fdc9f5ea3fa3d62671979ccf1
cd ../..
./configure --prefix=$install_dir CC=gcc CXX=g++
make
make install
git rm tools/clang
git rm .gitmodules 
git clean -df 
cd ..

echo
echo "################## BUILDING CMAKE ######################################"
echo 
cd cmake 
./configure --prefix=$install_dir
make
make install
git clean -df 
cd ..


export CC=$install_dir/bin/clang
export CXX=$install_dir/bin/clang++

echo
echo "################## BUILDING GNUSTEP Makefiles ######################################"
echo 
cd gnustep-make
./configure --prefix=$install_dir
make
make install
cd ..

export GNUSTEP_MAKEFILES=$install_dir/share/GNUstep/Makefiles
export PATH=$install_dir/bin/:$PATH
export LD_LIBRARY_PATH=$install_dir/lib/:/usr/lib:/lib/

echo
echo "################## BUILDING GNUSTEP OBJC ##########################################"
echo 
cd gnustep-libobjc2
make 
make install
cd ..

echo
echo "################## BUILDING GNUSTEP Makefiles (again) ######################################"
echo 
cd gnustep-make
./configure --prefix=$install_dir
make
make install
cd ..

echo
echo "################## BUILDING GNUSTEP BASE ##########################################"
echo
cd gnustep-base
./configure --prefix=$install_dir --disable-importing-config-file
make
make install
cd ..

echo
echo "################## CLEAN UP ##########################################"
echo
for d in gnustep-base  gnustep-libobjc2  gnustep-make
do
    cd $d ; git clean -df; cd -
done

echo
echo "################## Install KitKit files ####################################"
echo
dest=$install_dir/share/cmake-2.8/Modules/KitKit.cmake
cp files/cmake/Modules/KitKit.cmake $dest 
sed -i -e "s,__KITKIT_PREFIX__,$install_dir,g" $dest

mkdir -p $install_dir $install_dir/etc/ld.so.conf.d
dest=$install_dir/etc/ld.so.conf.d/kitkit.conf
cp files/etc/ld.so.conf.d/kitkit.conf $dest 
sed -i -e "s,__KITKIT_PREFIX__,$install_dir,g" $dest
ln -s $dest /etc/ld.so.conf.d/
ldconfig
